rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Users can read and update their own user document
    match /users/{userId} {
      allow read, update: if request.auth.uid == userId;
      allow create: if request.auth.uid != null;
    }

    // Rules for rooms
    match /rooms/{roomId} {
      // Allow a user to read a room document if they are a member of that room.
      allow read: if request.auth.uid in resource.data.members;
      
      // Allow a user to update a room document (e.g., to add a new member) if they are authenticated.
      // We check for membership on subcollection writes.
      allow update: if request.auth.uid != null;
      
      // Allow a user to create a room if they are authenticated and are listed as the creator and a member.
      allow create: if request.auth.uid == request.resource.data.creatorId 
                      && request.auth.uid in request.resource.data.members;

      // Function to check if the requesting user is a member of the current room.
      function isRoomMember() {
        return request.auth.uid in get(/databases/$(database)/documents/rooms/$(roomId)).data.members;
      }
      
      // Annotations
      match /annotations/{annotationId} {
        allow read, write: if isRoomMember();
      }

      // Highlights
      match /highlights/{highlightId} {
        allow read, write: if isRoomMember();
      }

      // Messages
      match /messages/{messageId} {
        allow read: if isRoomMember();
        allow create: if isRoomMember() && (request.resource.data.userId == request.auth.uid || request.resource.data.userId == 'system');
      }

      // Bookmarks
      match /bookmarks/{bookmarkId} {
        allow read: if isRoomMember();
        allow create: if isRoomMember() && request.resource.data.userId == request.auth.uid;
        allow delete: if isRoomMember() && resource.data.userId == request.auth.uid;
      }
    }
  }
}
