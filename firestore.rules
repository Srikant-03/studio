rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Users can read and update their own user document
    match /users/{userId} {
      allow read, update: if request.auth.uid == userId;
      allow create: if request.auth.uid != null;
    }

    // Rules for rooms
    match /rooms/{roomId} {
      // Any authenticated user can read the room's main document,
      // but listing rooms is disallowed.
      allow get: if request.auth.uid != null;
      // Only members can list rooms (e.g. in their bookshelf)
      allow list: if request.auth.uid in resource.data.members;

      allow create: if request.auth.uid == request.resource.data.creatorId && request.auth.uid in request.resource.data.members;
      allow update: if request.auth.uid in resource.data.members;

      // Rules for subcollections within a room
      function isRoomMember() {
        return request.auth.uid in get(/databases/$(database)/documents/rooms/$(roomId)).data.members;
      }
      
      // Annotations
      match /annotations/{annotationId} {
        allow read: if isRoomMember();
        allow create: if isRoomMember() && request.resource.data.userId == request.auth.uid;
      }

      // Highlights
      match /highlights/{highlightId} {
        allow read: if isRoomMember();
        allow create: if isRoomMember() && request.resource.data.userId == request.auth.uid;
      }

      // Messages
      match /messages/{messageId} {
        allow read: if isRoomMember();
        allow create: if isRoomMember() && (request.resource.data.userId == request.auth.uid || request.resource.data.userId == 'system');
      }

      // Bookmarks
      match /bookmarks/{bookmarkId} {
        allow read: if isRoomMember();
        allow create: if isRoomMemb er() && request.resource.data.userId == request.auth.uid;
        allow delete: if isRoomMember() && resource.data.userId == request.auth.uid;
      }
    }
  }
}
